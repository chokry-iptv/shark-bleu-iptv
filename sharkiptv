class IPTVService {
    constructor() {
        this.corsProxies = [
            'https://corsproxy.io/?',
            'https://api.codetabs.com/v1/proxy?quest=',
            'https://cors-anywhere.herokuapp.com/'
        ];
        this.currentProxyIndex = 0;
        this.allChannels = [];
        this.featuredMovies = [];
        this.featuredSeries = [];
        this.favorites = {};
        this.db = null;
        this.accessCode = null;
        this.isUsingFallback = false;
        this.cacheTimestamp = null;
        this.CACHE_EXPIRY_HOURS = 12;
        this.isLocalFile = window.location.protocol === 'file:';
    }

    async initialize(showToast) {
        this.showToast = showToast;
        const firebaseConnected = await this.initFirebase();
        
        if (!firebaseConnected) {
            // Ø¥Ø°Ø§ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨ÙØ§ÙŠØ±Ø¨ÙŠØ²ØŒ Ø§Ø³ØªØ®Ø¯Ù… ÙˆØ¶Ø¹ Ø¹Ø¯Ù… Ø§Ù„Ø§ØªØµØ§Ù„ Ù…Ø¨Ø§Ø´Ø±Ø©
            this.isUsingFallback = true;
            document.getElementById('authStatus').textContent = 'ğŸ”´ ÙˆØ¶Ø¹ Ø¹Ø¯Ù… Ø§Ù„Ø§ØªØµØ§Ù„';
            this.showToast('ØªÙ… Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¥Ù„Ù‰ ÙˆØ¶Ø¹ Ø¹Ø¯Ù… Ø§Ù„Ø§ØªØµØ§Ù„', 'info');
        }
        
        return firebaseConnected;
    }

    async initFirebase() {
        try {
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }
            this.db = firebase.firestore();
            
            // Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„
            await this.db.collection('test').limit(1).get();
            
            document.getElementById('authStatus').textContent = 'âœ… Ù…ØªØµÙ„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª';
            return true;
        } catch (error) {
            console.error("Firebase Error:", error);
            document.getElementById('authStatus').textContent = 'âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª';
            this.showToast('ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙˆØ¶Ø¹ Ø¹Ø¯Ù… Ø§Ù„Ø§ØªØµØ§Ù„.', 'error');
            return false;
        }
    }

    async authenticate(code) {
        if (!this.validateAccessCode(code)) {
            return false;
        }

        // Ø¥Ø°Ø§ ÙƒÙ†Ø§ ÙÙŠ ÙˆØ¶Ø¹ Ø¹Ø¯Ù… Ø§Ù„Ø§ØªØµØ§Ù„ Ø£Ùˆ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨ÙØ§ÙŠØ±Ø¨ÙŠØ²
        if (!this.db || this.isUsingFallback) {
            this.showToast('âœ… ØªÙ… Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­ (ÙˆØ¶Ø¹ Ø¹Ø¯Ù… Ø§Ù„Ø§ØªØµØ§Ù„)', 'success');
            this.accessCode = code;
            this.isUsingFallback = true;
            await this.loadContent();
            return true;
        }

        try {
            const docRef = this.db.collection(ACCESS_CODE_COLLECTION).doc(code);
            const doc = await docRef.get();

            if (doc.exists) {
                const data = doc.data();
                
                if (data.active === false) {
                    this.showToast('âŒ ØªÙ… Ø¥ÙŠÙ‚Ø§Ù ØªÙØ¹ÙŠÙ„ Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ Ù…Ù† Ù‚ÙØ¨Ù„ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©.', 'error');
                    return false;
                }

                if (data.expiry_date) {
                    const expiryDate = data.expiry_date.toDate();
                    const currentDate = new Date();

                    if (currentDate > expiryDate) {
                        this.showToast('âŒ Ø§Ù†ØªÙ‡Øª ØµÙ„Ø§Ø­ÙŠØ© Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ¬Ø¯ÙŠØ¯.', 'error');
                        return false;
                    }
                    
                    const sevenDaysInMillis = 7 * 24 * 60 * 60 * 1000;
                    const timeRemaining = expiryDate.getTime() - currentDate.getTime();
                    
                    if (timeRemaining < sevenDaysInMillis) {
                        const days = Math.ceil(timeRemaining / (1000 * 3600 * 24));
                        this.showToast(`âš ï¸ Ø³ÙŠÙ†ØªÙ‡ÙŠ Ø§Ø´ØªØ±Ø§ÙƒÙƒ Ø®Ù„Ø§Ù„ ${days} Ø£ÙŠØ§Ù…!`, 'warning');
                    }
                }

                this.accessCode = code;
                this.isUsingFallback = false;
                this.showToast('âœ… ØªÙ… Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­! Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰...', 'success');
                
                await this.loadFavorites();
                await this.loadContent();
                
                return true;
            } else {
                this.showToast('âŒ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø°ÙŠ Ø£Ø¯Ø®Ù„ØªÙ‡ ØºÙŠØ± ØµØ­ÙŠØ­.', 'error');
                return false;
            }

        } catch (error) {
            console.error("Authentication Error:", error);
            this.showToast('âš ï¸ ØªÙ… Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨ÙˆØ¶Ø¹ Ø¹Ø¯Ù… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø³Ø¨Ø¨ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù…', 'warning');
            this.accessCode = code;
            this.isUsingFallback = true;
            await this.loadContent();
            return true;
        }
    }
    
    validateAccessCode(code) {
        if (!code || code.toString().length < 4) {
            this.showToast('Ø§Ù„ÙƒÙˆØ¯ ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ 4 Ø£Ø±Ù‚Ø§Ù… Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„', 'error');
            return false;
        }
        if (!/^\d+$/.test(code.toString())) {
            this.showToast('Ø§Ù„ÙƒÙˆØ¯ ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø£Ø±Ù‚Ø§Ù… ÙÙ‚Ø·', 'error');
            return false;
        }
        return true;
    }

    async loadContent() {
        // Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø®Ø²Ù†Ø© Ù…Ø¤Ù‚ØªØ§Ù‹ Ø£ÙˆÙ„Ø§Ù‹
        const cachedData = this.loadCache();

        if (cachedData && cachedData.channels && cachedData.channels.length > 0) {
            this.processContent(cachedData.channels);
            this.showToast('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ù…Ù† Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ©.', 'success');
            this.updateCacheInBackground();
            return;
        }

        // Ø¥Ø°Ø§ ÙƒÙ†Ø§ ÙÙŠ ÙˆØ¶Ø¹ Ø¹Ø¯Ù… Ø§Ù„Ø§ØªØµØ§Ù„ØŒ Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù…Ø¨Ø§Ø´Ø±Ø©
        if (this.isUsingFallback || !this.db) {
            this.useFallbackData();
            this.showToast('ğŸ“¡ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© (ÙˆØ¶Ø¹ Ø¹Ø¯Ù… Ø§Ù„Ø§ØªØµØ§Ù„)', 'info');
            return;
        }

        try {
            this.showToast('Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ù†ÙˆØ§Øª Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...', 'info');
            
            const snapshot = await this.db.collection(CHANNELS_COLLECTION).get();
            const allContent = snapshot.docs.map(doc => ({ 
                id: doc.id, 
                ...doc.data(),
                // Ø¥Ø¶Ø§ÙØ© Ø­Ù‚ÙˆÙ„ Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙÙ‚ÙˆØ¯Ø©
                category: doc.data().category || 'Ø¹Ø§Ù…',
                name: doc.data().name || doc.data().title || 'Ù‚Ù†Ø§Ø© ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙØ©'
            }));

            if (allContent.length > 0) {
                this.processContent(allContent);
                this.saveCache(allContent);
                this.showToast(`âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ${allContent.length} Ù‚Ù†Ø§Ø© Ø¨Ù†Ø¬Ø§Ø­.`, 'success');
            } else {
                throw new Error('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚Ù†ÙˆØ§Øª ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
            }
        } catch (error) {
            console.error('Error loading content:', error);
            this.showToast('âš ï¸ ÙØ´Ù„ Ø¬Ù„Ø¨ Ø§Ù„Ù‚Ù†ÙˆØ§ØªØŒ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©.', 'warning');
            this.useFallbackData();
        }
    }

    async updateCacheInBackground() {
        if (!this.db || this.isUsingFallback) return;
        
        try {
            const snapshot = await this.db.collection(CHANNELS_COLLECTION).get();
            const allContent = snapshot.docs.map(doc => ({ 
                id: doc.id, 
                ...doc.data() 
            }));

            if (allContent.length > 0) {
                this.processContent(allContent);
                this.saveCache(allContent);
                console.log('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ© ÙÙŠ Ø§Ù„Ø®Ù„ÙÙŠØ©.');
            }
        } catch (error) {
            console.warn("Background cache update failed:", error);
        }
    }

    loadCache() {
        try {
            const stored = localStorage.getItem(CHANNELS_CACHE_KEY);
            if (!stored) return null;

            const data = JSON.parse(stored);
            const now = Date.now();
            const expiryTime = this.CACHE_EXPIRY_HOURS * 60 * 60 * 1000;

            if (now - data.timestamp < expiryTime && data.channels && data.channels.length > 0) {
                return data;
            } else {
                localStorage.removeItem(CHANNELS_CACHE_KEY);
                return null;
            }
        } catch (e) {
            console.error("Error loading cache:", e);
            localStorage.removeItem(CHANNELS_CACHE_KEY);
            return null;
        }
    }

    saveCache(channels) {
        const dataToStore = {
            timestamp: Date.now(),
            channels: channels
        };
        try {
            localStorage.setItem(CHANNELS_CACHE_KEY, JSON.stringify(dataToStore));
        } catch (e) {
            console.error("Error saving cache:", e);
        }
    }
    
    cleanChannelName(name) {
        if (!name || typeof name !== 'string') return 'Ù‚Ù†Ø§Ø© ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙØ©';
        
        // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¨Ø§Ø¯Ø¦Ø§Øª Ø§Ù„Ø±Ù‚Ù…ÙŠØ© ÙˆØ§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ÙÙ†ÙŠØ©
        const cleaned = name
            .replace(/^[\d\s\-\.]+/, '') // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø£Ø±Ù‚Ø§Ù… ÙˆØ§Ù„Ø´Ø±Ø·Ø§Øª ÙˆØ§Ù„Ù†Ù‚Ø§Ø· Ù…Ù† Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
            .replace(/\s*tvg-.*$/, '') // Ø¥Ø²Ø§Ù„Ø© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª tvg
            .replace(/\s*group-title="[^"]*"/, '') // Ø¥Ø²Ø§Ù„Ø© group-title
            .trim();
        
        return cleaned || 'Ù‚Ù†Ø§Ø© ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙØ©';
    }
    
    processContent(allContent) {
        if (!allContent || !Array.isArray(allContent)) {
            console.error('Invalid content data:', allContent);
            this.useFallbackData();
            return;
        }

        // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£ÙˆÙ„Ø§Ù‹
        allContent.forEach(channel => {
            // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ù…ÙˆØ¬ÙˆØ¯Ø©
            channel.id = channel.id || `channel_${Math.random().toString(36).substr(2, 9)}`;
            channel.category = channel.category ? String(channel.category).trim() : 'Ø¹Ø§Ù…';
            channel.name = this.cleanChannelName(channel.name || channel.title || 'Ù‚Ù†Ø§Ø© ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙØ©');
            channel.url = channel.url || '';
            
            const categoryString = channel.category;
            channel.categoryString = categoryString.toLowerCase();

            // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ÙØ¦Ø§Øª
            if (categoryString.trim().length > 0) {
                channel.cleanedCategories = categoryString.split(/[;,|]/)
                    .map(c => c.trim())
                    .filter(c => c.length > 1);
            } else {
                channel.cleanedCategories = ['Ø¹Ø§Ù…'];
            }
            
            // Ø¥Ø¶Ø§ÙØ© Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„ÙØ¦Ø©
            channel.icon = this.getCategoryIcon(channel.category);
        });

        // ØªØµÙ†ÙŠÙ Ø§Ù„Ù…Ø­ØªÙˆÙ‰
        const liveChannels = allContent.filter(c => 
            c.categoryString && 
            !c.categoryString.includes('vod') && 
            !c.categoryString.includes('movie') && 
            !c.categoryString.includes('series')
        );
        
        const movies = allContent.filter(c => 
            c.categoryString && (
                c.categoryString.includes('Ø£ÙÙ„Ø§Ù…') || 
                c.categoryString.includes('vod') || 
                c.categoryString.includes('movie') ||
                c.categoryString.includes('ÙÙŠÙ„Ù…')
            )
        );
        
        const series = allContent.filter(c => 
            c.categoryString && (
                c.categoryString.includes('Ù…Ø³Ù„Ø³Ù„Ø§Øª') || 
                c.categoryString.includes('series') ||
                c.categoryString.includes('Ù…Ø³Ù„Ø³Ù„')
            )
        );
        
        this.allChannels = [...liveChannels, ...movies, ...series];
        
        this.featuredMovies = this.prepareContentData(movies, FALLBACK_MOVIES).slice(0, 6);
        this.featuredSeries = this.prepareContentData(series, FALLBACK_SERIES).slice(0, 6);
        
        console.log(`ğŸ“Š ØªÙ… Ù…Ø¹Ø§Ù„Ø¬Ø© ${this.allChannels.length} Ù‚Ù†Ø§Ø©: ${liveChannels.length} Ø¨Ø« Ù…Ø¨Ø§Ø´Ø±, ${movies.length} Ø£ÙÙ„Ø§Ù…, ${series.length} Ù…Ø³Ù„Ø³Ù„Ø§Øª`);
    }

    useFallbackData() {
        console.log('ğŸ”„ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©...');
        
        this.allChannels = [...FALLBACK_CHANNELS, ...FALLBACK_MOVIES, ...FALLBACK_SERIES];
        
        this.allChannels.forEach(channel => {
            channel.cleanedCategories = channel.category ? [channel.category] : ['Ø¹Ø§Ù…'];
            channel.categoryString = channel.category ? channel.category.toLowerCase() : 'Ø¹Ø§Ù…';
            channel.name = this.cleanChannelName(channel.name || channel.title);
            channel.icon = this.getCategoryIcon(channel.category);
        });
        
        this.featuredMovies = FALLBACK_MOVIES;
        this.featuredSeries = FALLBACK_SERIES;
        this.isUsingFallback = true;
        
        // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© ÙÙŠ Ø§Ù„ÙƒØ§Ø´
        this.saveCache(this.allChannels);
    }

    prepareContentData(list, fallbackList) {
        if (!list || list.length === 0) return fallbackList;
        
        return list.map((c) => ({
            id: c.id,
            title: c.name || c.title,
            description: c.description || c.category || 'Ù…Ø­ØªÙˆÙ‰ ÙÙŠØ¯ÙŠÙˆ Ø¹Ù†Ø¯ Ø§Ù„Ø·Ù„Ø¨.',
            poster: c.logo || c.poster || this.generatePlaceholder(c.name || c.title, c.category),
            url: c.url,
            duration: c.duration || 'VOD',
            rating: c.rating || '4.0',
            year: c.year || 'Ø¬Ø¯ÙŠØ¯',
            category: c.category,
            cleanedCategories: c.cleanedCategories,
            icon: c.icon
        }));
    }

    generatePlaceholder(name, category) {
        try {
            const cleanName = this.cleanChannelName(name || 'Ù‚Ù†Ø§Ø©');
            const categoryString = category ? String(category) : 'Ø¹Ø§Ù…';
            
            const colors = {
                'Ø£ÙÙ„Ø§Ù…': ['ff6b6b', 'ffffff'],
                'Ù…Ø³Ù„Ø³Ù„Ø§Øª': ['3f72af', 'ffffff'],
                'Ø£Ø®Ø¨Ø§Ø±': ['06d6a0', 'ffffff'],
                'Ø±ÙŠØ§Ø¶Ø©': ['ff9f1c', 'ffffff'],
                'Ø±ÙŠØ§Ø¶': ['ff9f1c', 'ffffff'],
                'Ø£Ø·ÙØ§Ù„': ['5E548E', 'ffffff'],
                'ØªØ±ÙÙŠÙ‡': ['8B5CF6', 'ffffff'],
                'Ø¯ÙŠÙ†ÙŠØ©': ['10B981', 'ffffff'],
                'ÙˆØ«Ø§Ø¦Ù‚ÙŠØ©': ['6B7280', 'ffffff'],
                'Ø¹Ø§Ù…': ['6B7280', 'ffffff'],
                'default': ['3f72af', 'ffffff']
            };

            const categoryLower = categoryString.toLowerCase();
            let [bgColor, textColor] = colors.default;

            for (const key in colors) {
                if (categoryLower.includes(key.toLowerCase())) {
                    [bgColor, textColor] = colors[key];
                    break;
                }
            }

            return this.generateSVGPlaceholder(cleanName, bgColor, textColor);
        } catch (error) {
            console.error('Error generating placeholder:', error);
            return this.generateSVGPlaceholder('Ù‚Ù†Ø§Ø©', '3f72af', 'ffffff');
        }
    }

    generateSVGPlaceholder(text, bgColor, textColor) {
        const cleanText = text && text.length > 0 ? text.substring(0, 12) : 'Ù‚Ù†Ø§Ø©';
        const svg = `
            <svg width="300" height="450" xmlns="http://www.w3.org/2000/svg">
                <rect width="100%" height="100%" fill="#${bgColor}"/>
                <text x="50%" y="50%" text-anchor="middle" dy=".3em" 
                      fill="#${textColor}" font-family="Arial, sans-serif" font-size="18" font-weight="bold">
                    ${cleanText}
                </text>
            </svg>
        `;
        return 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(svg);
    }

    getCategoryIcon(category) {
        if (!category) return 'ğŸ“º';
        
        const categoryString = String(category).toLowerCase();
        
        if (categoryString.includes('Ø£ÙÙ„Ø§Ù…') || categoryString.includes('movie') || categoryString.includes('cinema') || categoryString.includes('film')) return 'ğŸ¬';
        if (categoryString.includes('Ù…Ø³Ù„Ø³Ù„Ø§Øª') || categoryString.includes('series') || categoryString.includes('Ù…Ø³Ù„Ø³Ù„')) return 'ğŸ“º';
        if (categoryString.includes('Ø£Ø®Ø¨Ø§Ø±') || categoryString.includes('news') || categoryString.includes('Ø¥Ø®Ø¨Ø§Ø±')) return 'ğŸ“°';
        if (categoryString.includes('Ø±ÙŠØ§Ø¶') || categoryString.includes('sport') || categoryString.includes('Ø±ÙŠØ§Ø¶Ø©')) return 'âš½';
        if (categoryString.includes('Ø£Ø·ÙØ§Ù„') || categoryString.includes('kids') || categoryString.includes('child')) return 'ğŸ§¸';
        if (categoryString.includes('ÙˆØ«Ø§Ø¦Ù‚ÙŠ') || categoryString.includes('documentary')) return 'ğŸ“œ';
        if (categoryString.includes('Ù…ÙˆØ³ÙŠÙ‚Ù‰') || categoryString.includes('music')) return 'ğŸµ';
        if (categoryString.includes('Ø¯ÙŠÙ†') || categoryString.includes('religious') || categoryString.includes('Ø¯ÙŠÙ†ÙŠØ©')) return 'ğŸ•Œ';
        if (categoryString.includes('ØªØ±ÙÙŠÙ‡') || categoryString.includes('entertainment')) return 'ğŸ­';
        if (categoryString.includes('ØªØ¹Ù„ÙŠÙ…') || categoryString.includes('education')) return 'ğŸ“š';

        return 'ğŸ“º';
    }

    async loadFavorites() {
        if (!this.db || !this.accessCode || this.isUsingFallback) {
            // ÙÙŠ ÙˆØ¶Ø¹ Ø¹Ø¯Ù… Ø§Ù„Ø§ØªØµØ§Ù„ØŒ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙØ¶Ù„Ø© Ù…Ù† localStorage
            const localFavorites = localStorage.getItem(`favorites_${this.accessCode}`);
            if (localFavorites) {
                try {
                    this.favorites = JSON.parse(localFavorites);
                } catch (e) {
                    console.error('Error loading local favorites:', e);
                    this.favorites = {};
                }
            }
            return;
        }

        try {
            const doc = await this.db.collection(USER_FAVORITES_COLLECTION).doc(this.accessCode).get();
            if (doc.exists && doc.data().favorites) {
                this.favorites = doc.data().favorites;
            }
        } catch (error) {
            console.error("Error loading favorites:", error);
        }
    }

    async toggleFavorite(channel) {
        if (!channel || !channel.id) {
            this.showToast('âŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ù‡Ø°Ù‡ Ø§Ù„Ù‚Ù†Ø§Ø© Ø¥Ù„Ù‰ Ø§Ù„Ù…ÙØ¶Ù„Ø©', 'error');
            return false;
        }

        // ÙÙŠ ÙˆØ¶Ø¹ Ø¹Ø¯Ù… Ø§Ù„Ø§ØªØµØ§Ù„ØŒ Ø§Ø³ØªØ®Ø¯Ù… localStorage
        if (this.isUsingFallback || !this.db) {
            const wasFavorite = this.isFavorite(channel.id);
            
            if (wasFavorite) {
                delete this.favorites[channel.id];
                this.showToast(`ØªÙ…Øª Ø¥Ø²Ø§Ù„Ø© ${channel.name || channel.title} Ù…Ù† Ø§Ù„Ù…ÙØ¶Ù„Ø©.`, 'info');
            } else {
                this.favorites[channel.id] = channel;
                this.showToast(`ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© ${channel.name || channel.title} Ø¥Ù„Ù‰ Ø§Ù„Ù…ÙØ¶Ù„Ø©!`, 'success');
            }
            
            // Ø­ÙØ¸ ÙÙŠ localStorage
            localStorage.setItem(`favorites_${this.accessCode}`, JSON.stringify(this.favorites));
            return true;
        }

        if (!this.accessCode) {
            this.showToast('ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹.', 'error');
            return false;
        }

        const wasFavorite = this.isFavorite(channel.id);
        
        if (wasFavorite) {
            delete this.favorites[channel.id];
            this.showToast(`ØªÙ…Øª Ø¥Ø²Ø§Ù„Ø© ${channel.name || channel.title} Ù…Ù† Ø§Ù„Ù…ÙØ¶Ù„Ø©.`, 'info');
        } else {
            this.favorites[channel.id] = channel;
            this.showToast(`ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© ${channel.name || channel.title} Ø¥Ù„Ù‰ Ø§Ù„Ù…ÙØ¶Ù„Ø©!`, 'success');
        }
        
        try {
            await this.db.collection(USER_FAVORITES_COLLECTION).doc(this.accessCode).set({ 
                favorites: this.favorites 
            }, { merge: true });
            return true;
        } catch (error) {
            console.error("Error saving favorites:", error);
            // Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ø§Ù„ØªØºÙŠÙŠØ±
            if (wasFavorite) {
                this.favorites[channel.id] = channel;
            } else {
                delete this.favorites[channel.id];
            }
            this.showToast('ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ù…ÙØ¶Ù„Ø©.', 'error');
            return false;
        }
    }

    isFavorite(channelId) {
        return !!this.favorites[channelId];
    }

    getAllChannels() { 
        return this.allChannels || []; 
    }
    
    getFeaturedMovies() { 
        return this.featuredMovies || []; 
    }
    
    getFeaturedSeries() { 
        return this.featuredSeries || []; 
    }
    
    getFavoritesList() { 
        return Object.values(this.favorites); 
    }

    searchChannels(query) {
        if (!query || !this.allChannels) return [];
        
        const q = query.toLowerCase().trim();
        return this.allChannels.filter(c => 
            (c.name && c.name.toLowerCase().includes(q)) ||
            (c.title && c.title.toLowerCase().includes(q)) ||
            (c.category && c.category.toLowerCase().includes(q)) ||
            (c.description && c.description.toLowerCase().includes(q))
        );
    }

    // CORS Proxy methods
    async getProxiedUrl(originalUrl) {
        if (!originalUrl) return originalUrl;
        
        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø±Ø§Ø¨Ø· Ù…Ø­Ù„ÙŠØ§Ù‹ØŒ Ù„Ø§ ØªØ³ØªØ®Ø¯Ù… Ø¨Ø±ÙˆÙƒØ³ÙŠ
        if (originalUrl.startsWith('data:') || originalUrl.startsWith('blob:')) {
            return originalUrl;
        }

        for (let i = 0; i < this.corsProxies.length; i++) {
            const proxyIndex = (this.currentProxyIndex + i) % this.corsProxies.length;
            const proxyUrl = this.corsProxies[proxyIndex] + encodeURIComponent(originalUrl);
            
            try {
                const response = await fetch(proxyUrl, { method: 'HEAD' });
                if (response.ok) {
                    this.currentProxyIndex = proxyIndex;
                    return proxyUrl;
                }
            } catch (error) {
                console.warn(`Proxy ${proxyIndex} failed:`, error);
            }
        }
        
        return originalUrl;
    }

    // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
    cleanupOldData() {
        const now = Date.now();
        const oneDayAgo = now - (24 * 60 * 60 * 1000);
        
        // ØªÙ†Ø¸ÙŠÙ Ø§Ù„ÙƒØ§Ø´ Ø§Ù„Ù‚Ø¯ÙŠÙ…
        Object.keys(localStorage).forEach(key => {
            if (key.startsWith('iptv_')) {
                try {
                    const data = JSON.parse(localStorage.getItem(key));
                    if (data && data.timestamp && data.timestamp < oneDayAgo) {
                        localStorage.removeItem(key);
                    }
                } catch (e) {
                    // ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
                }
            }
        });
    }
}
